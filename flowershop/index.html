<!DOCTYPE html>
<html>
<head>
    <title></title>
	<meta charset="utf-8" />
	<script src="cordova.js"></script>
	<script src="kendo/js/jquery.min.js"></script>
	<script src="kendo/js/kendo.mobile.min.js"></script>
    <script src="scripts/datajs-1.0.3.min.js" type="text/javascript"></script>
	<script src="scripts/jaydata.js" type="text/javascript"></script>
	<script src="scripts/jaydatamodules/kendo.js" type="text/javascript"></script>
    <script src="scripts/mydatabase.js" type="text/javascript"></script>

	<link href="kendo/styles/kendo.mobile.all.min.css" rel="stylesheet" />
	<link href="styles/main.css" rel="stylesheet" />
    <style scoped>
        #forms input:not([type=checkbox]):not([type=radio]),
        #forms select,
        #forms .k-dropdown
        {
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            width: 50%;
        }
    </style>
</head>
<body>

    <div data-role="view" id="tabstrip-forms" data-model="viewModel" data-title="Surveys">
        <header data-role="header">
            <div data-role="navbar">
                <a data-align="right" data-icon="add" data-role="button" data-bind="click: newSurvey">New</a>
            </div>
        </header>
        <ul id="listView"
            data-role="listview"
            data-style="inset"
            data-template="template"
            data-bind="source: myDatabase, events: { click: show }">
        </ul>
    </div>
    
	<script id="template" type="text/x-kendo-template">
		<div class="info">
		<h3>${ data.Name }</h3>
		</div>
	</script>

    <div data-role="view" id="tabstrip-show" data-model="viewModel" data-title="Show survey">
        <header data-role="header">
            <div data-role="navbar">
                <button class="nav-button" data-align="left" data-role="button" data-bind="click: back">Back</button>
                <button data-align="right" data-role="button" data-bind="click: del">Delete</button>
                <button data-align="right" data-role="button" data-bind="click: edit">Edit</button>
            </div>
        </header>
        <ul data-role="listview" data-style="inset">
            <li>Name <span class="sales-up" data-bind="text: survey.Name"></span></li>
            <li>Age <span class="sales-up" data-bind="text: survey.Age"></span></li>
            <!--<li>Continent <span class="sales-up" data-bind="text: survey.Continent"></span></li>-->
            <li>Reason <span class="sales-up" data-bind="text: survey.Reason"></span></li>
        </ul>
    </div>

    <div data-role="view" id="tabstrip-form" data-model="viewModel" data-title="New survey">
        <header data-role="header">
            <div data-role="navbar">
                <button class="nav-button" data-align="left" data-role="button" data-bind="click: back">Back</button>
                <button data-align="right" data-role="button" data-bind="click: add, visible: isNew, enabled: hasChanges">Add</button>
                <button data-align="right" data-role="button" data-bind="click: save, visible: isNotNew, enabled: hasChanges">Save</button>
            </div>
        </header>
        <form id="surveyForm">
            <ul data-role="listview" data-style="inset">
                <li>
                    <label for="fullname" class="required">Your Name</label>
                    <input  data-bind="value: survey.Name" type="text" placeholder="name" required validationMessage="Cannot be empty" />
                </li>
                <li>
                    <select data-value-field="name" data-text-field="name" data-bind="source: Ages, value: survey.Age, events: { change: change }" required></select>
                    Your Age:
                </li>
                <!--
                <li>
                    <select data-value-field="name" data-text-field="name" data-bind="source: Continents, value: survey.Continent, events: { change: change }" required></select>
                    Visited continent:
                </li>
                -->
                <li>
                    <select data-value-field="name" data-text-field="name" data-bind="source: Reasons, value: survey.Reason, events: { change: change }" required></select>
                    Reason of travel:
                </li>
            </ul>
        </form>
    </div>

    <script>
        var app = null;
        var viewModel = null;
        var lctx = new mydatabase({name: 'local', databaseName: 'surveys'});
        $.when($.ready, lctx.onReady())
        .then(function () {
            // TODO fix this
            var validator = $("#surveyForm").kendoValidator().data("kendoValidator");
            viewModel = kendo.observable({
                myDatabase: lctx.TravelPreferences.asKendoDataSource(),
                survey:  null,
                Ages: [ { id: 0, name: "" }, { id: 1, name: "under 18"}, { id: 2, name: "18-27"}, { id: 3, name: "28-44"}, 
                        { id: 4, name: "45-62"}, { id: 5, name: "Over 63" } ],
                Continents: [ { id: 0, name: "" },{ id: 1, name: "Europe"},{ id: 2, name: "North America"},{ id: 3, name: "South America" },
                              { id: 4, name: "Asia"}, { id: 5, name: "Africa"}, {id: 6, name: "Australia"}],
                Reasons: [ { id: 0, name: "" },{ id: 1, name: "Vacation"}, { id: 2, name: "Business"},{ id: 3, name: "Family/friend visit"},{ id: 4, name: "Other"}],
                add: function() {
                    if (validator.validate() && viewModel.hasChanges) { // && viewModel.hasChanges needed because it is called multiple times
                        viewModel.myDatabase.add( viewModel.survey );
                        viewModel.save();
                    }
                },
                save: function() {
                    if (validator.validate()) {
                        viewModel.myDatabase.sync();
                        viewModel.set('hasChanges', false);
                        viewModel.set('survey', undefined); // TODO remove
                        app.navigate('#tabstrip-forms');
                    }
                },
                back: function() {
                    viewModel.set('survey', undefined); // TODO remove
                    app.navigate('#tabstrip-forms');
                },
                newSurvey: function(e) {
                    if (viewModel.survey) return; // needed because it is called multiple times
                    viewModel.set('survey',new viewModel.myDatabase.options.schema.model()),
                    viewModel.set('survey.Age', ""),
                    viewModel.set('survey.Continent', ""),
                    viewModel.set('survey.Reason', ""),
                    viewModel.set('hasChanges', false);
                    viewModel.set('isNew',true);
                    viewModel.set('isNotNew',false);
                    app.navigate('#tabstrip-form');
                },
                del: function(e) {
                    viewModel.myDatabase.remove(viewModel.survey);
                    viewModel.save();
                },
                show: function(e) {
                    viewModel.set('survey', e.dataItem);
                    app.navigate('#tabstrip-show');
                },
                edit: function(e) {
                    viewModel.set('isNew',false);
                    viewModel.set('isNotNew',true);
                    app.navigate('#tabstrip-form');
                },
                isNew: function() { return viewModel.survey.id == undefined;},
                isNotNew: function() { return !viewModel.isNew(); },
                hasChanges: false,
                change: function() {
                    viewModel.set('hasChanges', true);
                }
            });
            app = new kendo.mobile.Application(document.body);
        });                
    </script>
</body>
</html>
// hibak:
// megjelenites ha id van es number
// dupla hivasok
// validalas
// button disable
// startup....elejen nincs inicializalva
// dropppolja a db-t

                        